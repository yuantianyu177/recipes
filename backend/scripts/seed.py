#!/usr/bin/env python3
"""
Seed the database with sample data.

Usage (dev):
  cd backend
  python scripts/seed.py          # Insert seed data
  python scripts/seed.py --reset  # Drop all tables, recreate, then seed

Usage (Docker production):
  docker compose exec backend python scripts/seed.py --reset
"""
import asyncio
import json
import sys
import os

# Add the backend directory to the Python path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from sqlalchemy import select
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from app.core.config import settings
from app.core.database import Base
from app.models.models import (
    TagCategory, Tag, IngredientCategory, Ingredient,
    Recipe, RecipeIngredient,
)


# =====================================================
# Data definitions
# =====================================================

TAG_CATEGORIES = ["菜系", "口味", "场景", "烹饪方式", "难度"]

TAGS = [
    # cuisine
    ("川菜", "菜系"), ("粤菜", "菜系"), ("湘菜", "菜系"), ("鲁菜", "菜系"),
    ("苏菜", "菜系"), ("浙菜", "菜系"), ("闽菜", "菜系"), ("徽菜", "菜系"),
    ("家常菜", "菜系"), ("西餐", "菜系"), ("日料", "菜系"), ("韩餐", "菜系"),
    ("东南亚", "菜系"), ("西北菜", "菜系"), ("东北菜", "菜系"), ("云贵菜", "菜系"),
    # flavor
    ("麻辣", "口味"), ("酸甜", "口味"), ("咸鲜", "口味"), ("清淡", "口味"),
    ("香辣", "口味"), ("酱香", "口味"), ("蒜香", "口味"), ("葱香", "口味"),
    ("五香", "口味"), ("糖醋", "口味"), ("鱼香", "口味"), ("怪味", "口味"),
    ("椒麻", "口味"), ("咸甜", "口味"), ("鲜辣", "口味"), ("原味", "口味"),
    # scene
    ("早餐", "场景"), ("午餐", "场景"), ("晚餐", "场景"), ("夜宵", "场景"),
    ("下饭菜", "场景"), ("快手菜", "场景"), ("宴客菜", "场景"), ("下酒菜", "场景"),
    ("便当", "场景"), ("野餐", "场景"), ("减脂餐", "场景"), ("儿童餐", "场景"),
    ("节日菜", "场景"), ("聚餐", "场景"), ("一人食", "场景"),
    # cooking method
    ("炒", "烹饪方式"), ("蒸", "烹饪方式"), ("煮", "烹饪方式"), ("烤", "烹饪方式"),
    ("炖", "烹饪方式"), ("凉拌", "烹饪方式"), ("煎", "烹饪方式"), ("炸", "烹饪方式"),
    ("焖", "烹饪方式"), ("卤", "烹饪方式"), ("烧", "烹饪方式"), ("熏", "烹饪方式"),
    ("涮", "烹饪方式"), ("拌", "烹饪方式"), ("腌", "烹饪方式"), ("白灼", "烹饪方式"),
    # difficulty
    ("简单", "难度"), ("中等", "难度"), ("困难", "难度"),
]

INGREDIENT_CATEGORIES = ["主料", "辅料", "调料", "干货", "酱料"]

# (name, unit, calorie_per_unit, category)
INGREDIENTS = [
    # === Main ingredients - meat ===
    ("猪肉", "克", 1.43, "主料"), ("猪五花肉", "克", 3.95, "主料"),
    ("猪里脊", "克", 1.55, "主料"), ("猪排骨", "克", 2.78, "主料"),
    ("猪蹄", "克", 2.60, "主料"), ("肉末", "克", 2.10, "主料"),
    ("牛肉", "克", 1.06, "主料"), ("牛腩", "克", 3.32, "主料"),
    ("羊肉", "克", 2.03, "主料"), ("羊腿", "克", 1.80, "主料"),
    ("鸡肉", "克", 1.67, "主料"), ("鸡胸肉", "克", 1.33, "主料"),
    ("鸡腿", "个", 180.0, "主料"), ("鸡翅", "个", 90.0, "主料"),
    ("鸡爪", "个", 45.0, "主料"), ("鸭肉", "克", 2.40, "主料"),
    ("鸭腿", "个", 260.0, "主料"),
    # === Main ingredients - seafood ===
    ("虾", "只", 15.0, "主料"), ("虾仁", "克", 0.93, "主料"),
    ("大虾", "只", 35.0, "主料"), ("基围虾", "只", 12.0, "主料"),
    ("鱼", "条", 300.0, "主料"), ("鲈鱼", "条", 280.0, "主料"),
    ("带鱼", "条", 320.0, "主料"), ("三文鱼", "克", 1.39, "主料"),
    ("鳕鱼", "克", 0.88, "主料"), ("螃蟹", "只", 95.0, "主料"),
    ("蛤蜊", "克", 0.54, "主料"), ("扇贝", "个", 20.0, "主料"),
    ("鱿鱼", "克", 0.92, "主料"), ("墨鱼", "克", 0.83, "主料"),
    # === Main ingredients - egg & tofu ===
    ("鸡蛋", "个", 78.0, "主料"), ("鸭蛋", "个", 90.0, "主料"),
    ("皮蛋", "个", 90.0, "主料"), ("鹌鹑蛋", "个", 15.0, "主料"),
    ("豆腐", "块", 76.0, "主料"), ("嫩豆腐", "块", 62.0, "主料"),
    ("老豆腐", "块", 81.0, "主料"), ("豆腐皮", "张", 45.0, "主料"),
    ("腐竹", "克", 4.59, "主料"), ("豆干", "块", 35.0, "主料"),
    # === Main ingredients - vegetables ===
    ("白菜", "棵", 15.0, "主料"), ("大白菜", "棵", 35.0, "主料"),
    ("小白菜", "棵", 8.0, "主料"), ("菠菜", "把", 20.0, "主料"),
    ("生菜", "棵", 12.0, "主料"), ("油麦菜", "把", 15.0, "主料"),
    ("空心菜", "把", 20.0, "主料"), ("西兰花", "朵", 35.0, "主料"),
    ("花菜", "朵", 25.0, "主料"), ("芹菜", "根", 8.0, "主料"),
    ("韭菜", "把", 18.0, "主料"), ("茼蒿", "把", 15.0, "主料"),
    ("西红柿", "个", 22.0, "主料"), ("茄子", "个", 25.0, "主料"),
    ("黄瓜", "根", 16.0, "主料"), ("苦瓜", "根", 22.0, "主料"),
    ("丝瓜", "根", 20.0, "主料"), ("冬瓜", "克", 0.12, "主料"),
    ("南瓜", "克", 0.23, "主料"), ("土豆", "个", 77.0, "主料"),
    ("红薯", "个", 102.0, "主料"), ("山药", "克", 0.57, "主料"),
    ("藕", "节", 70.0, "主料"), ("芋头", "个", 80.0, "主料"),
    ("玉米", "根", 112.0, "主料"), ("毛豆", "克", 1.31, "主料"),
    ("豌豆", "克", 1.11, "主料"), ("四季豆", "克", 0.30, "主料"),
    ("豆角", "克", 0.30, "主料"), ("荷兰豆", "克", 0.42, "主料"),
    ("青椒", "个", 22.0, "主料"), ("红椒", "个", 25.0, "主料"),
    ("彩椒", "个", 28.0, "主料"), ("秋葵", "根", 5.0, "主料"),
    ("蘑菇", "克", 0.20, "主料"), ("香菇", "朵", 5.0, "主料"),
    ("平菇", "克", 0.20, "主料"), ("金针菇", "克", 0.32, "主料"),
    ("杏鲍菇", "个", 25.0, "主料"), ("木耳", "克", 2.05, "主料"),
    # === Main ingredients - staple ===
    ("米饭", "碗", 232.0, "主料"), ("面条", "份", 280.0, "主料"),
    ("年糕", "克", 1.54, "主料"), ("粉丝", "把", 170.0, "主料"),
    ("河粉", "份", 260.0, "主料"), ("饺子皮", "张", 12.0, "主料"),
    ("馄饨皮", "张", 10.0, "主料"),
    # === Side ingredients ===
    ("葱", "根", 5.0, "辅料"), ("小葱", "根", 2.0, "辅料"),
    ("大葱", "根", 12.0, "辅料"), ("姜", "片", 2.0, "辅料"),
    ("蒜", "瓣", 4.0, "辅料"), ("洋葱", "个", 40.0, "辅料"),
    ("香菜", "棵", 3.0, "辅料"), ("胡萝卜", "根", 41.0, "辅料"),
    ("白萝卜", "根", 23.0, "辅料"), ("竹笋", "克", 0.25, "辅料"),
    ("芽菜", "克", 0.19, "辅料"), ("豆芽", "克", 0.18, "辅料"),
    ("紫菜", "克", 2.07, "辅料"), ("海带", "克", 0.12, "辅料"),
    ("红枣", "颗", 12.0, "辅料"), ("枸杞", "克", 2.51, "辅料"),
    ("芝麻", "克", 5.59, "辅料"), ("花生", "克", 5.67, "辅料"),
    ("核桃", "个", 40.0, "辅料"), ("松子", "克", 6.73, "辅料"),
    ("腊肉", "克", 4.98, "辅料"), ("火腿", "克", 2.78, "辅料"),
    ("培根", "片", 35.0, "辅料"), ("香肠", "根", 120.0, "辅料"),
    # === Seasonings ===
    ("盐", "勺", 0.0, "调料"), ("糖", "勺", 16.0, "调料"),
    ("白糖", "勺", 16.0, "调料"), ("冰糖", "粒", 5.0, "调料"),
    ("红糖", "勺", 15.0, "调料"), ("蜂蜜", "勺", 21.0, "调料"),
    ("酱油", "勺", 8.0, "调料"), ("生抽", "勺", 8.0, "调料"),
    ("老抽", "勺", 10.0, "调料"), ("蚝油", "勺", 9.0, "调料"),
    ("醋", "勺", 2.0, "调料"), ("香醋", "勺", 2.5, "调料"),
    ("陈醋", "勺", 2.0, "调料"), ("米醋", "勺", 2.0, "调料"),
    ("料酒", "勺", 10.0, "调料"), ("黄酒", "勺", 12.0, "调料"),
    ("白酒", "勺", 22.0, "调料"), ("胡椒粉", "克", 2.55, "调料"),
    ("白胡椒粉", "克", 2.55, "调料"), ("黑胡椒", "克", 2.55, "调料"),
    ("花椒", "克", 2.58, "调料"), ("花椒粉", "克", 2.58, "调料"),
    ("八角", "个", 4.0, "调料"), ("桂皮", "片", 5.0, "调料"),
    ("香叶", "片", 1.0, "调料"), ("草果", "个", 5.0, "调料"),
    ("干辣椒", "个", 3.0, "调料"), ("辣椒粉", "克", 3.14, "调料"),
    ("小米辣", "个", 3.0, "调料"), ("朝天椒", "个", 2.5, "调料"),
    ("五香粉", "克", 3.21, "调料"), ("十三香", "克", 3.0, "调料"),
    ("孜然粉", "克", 3.73, "调料"), ("孜然粒", "克", 3.73, "调料"),
    ("咖喱粉", "克", 3.25, "调料"), ("姜粉", "克", 3.35, "调料"),
    ("淀粉", "勺", 30.0, "调料"), ("玉米淀粉", "勺", 30.0, "调料"),
    ("面粉", "勺", 26.0, "调料"), ("食用油", "勺", 90.0, "调料"),
    ("橄榄油", "勺", 90.0, "调料"), ("芝麻油", "勺", 89.0, "调料"),
    ("花生油", "勺", 90.0, "调料"), ("菜籽油", "勺", 90.0, "调料"),
    ("黄油", "克", 7.17, "调料"), ("番茄酱", "勺", 15.0, "调料"),
    # === Dry goods ===
    ("虾皮", "克", 1.53, "干货"), ("干贝", "个", 10.0, "干货"),
    ("虾米", "克", 2.19, "干货"), ("干香菇", "朵", 15.0, "干货"),
    ("银耳", "朵", 20.0, "干货"), ("黄花菜", "克", 1.99, "干货"),
    ("干木耳", "克", 2.65, "干货"), ("桂圆", "颗", 10.0, "干货"),
    ("莲子", "克", 3.50, "干货"), ("百合", "克", 1.62, "干货"),
    ("陈皮", "克", 1.78, "干货"),
    # === Sauces ===
    ("豆瓣酱", "勺", 12.0, "酱料"), ("甜面酱", "勺", 18.0, "酱料"),
    ("辣椒酱", "勺", 15.0, "酱料"), ("豆豉", "勺", 18.0, "酱料"),
    ("腐乳", "块", 25.0, "酱料"), ("芝麻酱", "勺", 60.0, "酱料"),
    ("沙拉酱", "勺", 50.0, "酱料"), ("味噌", "勺", 15.0, "酱料"),
    ("XO酱", "勺", 20.0, "酱料"), ("沙茶酱", "勺", 25.0, "酱料"),
    ("辣椒油", "勺", 88.0, "酱料"), ("花椒油", "勺", 88.0, "酱料"),
    ("蒸鱼豉油", "勺", 8.0, "酱料"), ("味精", "克", 2.68, "酱料"),
    ("鸡精", "克", 2.30, "酱料"),
]

RECIPES = [
    {
        "name": "西红柿炒鸡蛋",
        "description": "家常经典菜品，酸甜可口，营养丰富，是每个家庭餐桌上的常客。",
        "steps": "<ol><li>西红柿切块，鸡蛋打散加少许盐搅匀</li><li>锅中倒油烧热，倒入蛋液炒至凝固盛出</li><li>锅中再加少许油，放入西红柿翻炒出汁</li><li>加入糖、盐调味，倒回鸡蛋翻炒均匀即可</li></ol>",
        "tips": "西红柿要炒出汁水，鸡蛋不要炒太老。可以加少许糖提鲜。",
        "tags": ["家常菜", "酸甜", "快手菜", "炒", "简单"],
        "ingredients": [("西红柿", "2"), ("鸡蛋", "3"), ("葱", "1"), ("盐", "1"), ("糖", "0.5"), ("食用油", "2")],
    },
    {
        "name": "麻婆豆腐",
        "description": "四川经典名菜，麻辣鲜香，豆腐嫩滑入味，是川菜的代表作之一。",
        "steps": "<ol><li>豆腐切小块，用开水焯一下捞出沥干</li><li>猪肉剁成肉末</li><li>锅中倒油，放入花椒、干辣椒煸香</li><li>加入肉末炒散变色</li><li>放入豆瓣酱炒出红油</li><li>加入生抽、老抽调味</li><li>放入豆腐轻轻翻炒，加少许水焖煮2分钟</li><li>水淀粉勾芡，撒上葱花和花椒粉即可</li></ol>",
        "tips": "豆腐焯水可以去豆腥味且不易碎。花椒要用小火慢慢煸出香味。",
        "tags": ["川菜", "麻辣", "下饭菜", "炒", "中等"],
        "ingredients": [
            ("嫩豆腐", "1"), ("肉末", "100"), ("葱", "2"), ("姜", "3"), ("蒜", "3"),
            ("花椒", "5"), ("花椒粉", "2"), ("干辣椒", "5"), ("豆瓣酱", "2"),
            ("生抽", "2"), ("老抽", "0.5"), ("淀粉", "1"), ("食用油", "3"), ("盐", "0.5"),
        ],
    },
    {
        "name": "红烧肉",
        "description": "色泽红亮、肥而不腻的经典硬菜，入口即化。",
        "steps": "<ol><li>猪五花肉切块，冷水下锅焯水去血沫，捞出洗净</li><li>锅中放少许油，加冰糖小火炒出糖色</li><li>放入肉块翻炒上色</li><li>加入生抽、老抽、料酒</li><li>加入姜片、葱段、八角、桂皮、香叶</li><li>加适量开水没过肉，大火烧开转小火炖1小时</li><li>大火收汁至浓稠即可</li></ol>",
        "tips": "炒糖色时要小火，糖色变琥珀色即可放肉。炖煮时间要足够才能软烂。",
        "tags": ["家常菜", "酱香", "宴客菜", "炖", "中等"],
        "ingredients": [
            ("猪五花肉", "500"), ("葱", "2"), ("姜", "5"), ("冰糖", "8"),
            ("生抽", "3"), ("老抽", "1"), ("料酒", "2"), ("八角", "2"),
            ("桂皮", "1"), ("香叶", "2"), ("食用油", "1"), ("盐", "0.5"),
        ],
    },
    {
        "name": "酸辣土豆丝",
        "description": "开胃下饭的经典家常菜，酸辣爽脆，几分钟就能上桌。",
        "steps": "<ol><li>土豆去皮切细丝，泡入清水中去淀粉</li><li>青椒切丝，蒜切末，干辣椒剪段</li><li>锅中倒油烧热，放入干辣椒、花椒爆香</li><li>放入蒜末略炒，下土豆丝大火快炒</li><li>加入醋、盐、生抽调味</li><li>放入青椒丝翻炒断生即可出锅</li></ol>",
        "tips": "土豆丝要切细并泡水去淀粉，炒的时候大火快炒保持脆爽。醋要早放才有酸味。",
        "tags": ["家常菜", "香辣", "快手菜", "下饭菜", "炒", "简单"],
        "ingredients": [
            ("土豆", "2"), ("青椒", "1"), ("蒜", "3"), ("干辣椒", "3"),
            ("花椒", "2"), ("醋", "2"), ("盐", "1"), ("生抽", "1"), ("食用油", "2"),
        ],
    },
    {
        "name": "蒜蓉西兰花",
        "description": "清爽健康的快手菜，蒜香浓郁，口感脆嫩，是减脂期的好选择。",
        "steps": "<ol><li>西兰花掰成小朵，洗净后焯水1分钟捞出过凉水</li><li>蒜切末</li><li>锅中倒少许油烧热，放入蒜末爆香</li><li>放入西兰花翻炒</li><li>加盐、蚝油调味，翻炒均匀即可</li></ol>",
        "tips": "焯水时加少许盐和油可以保持翠绿色。不要炒太久以保持口感。",
        "tags": ["家常菜", "蒜香", "清淡", "快手菜", "减脂餐", "炒", "简单"],
        "ingredients": [
            ("西兰花", "6"), ("蒜", "5"), ("蚝油", "1"),
            ("盐", "0.5"), ("食用油", "1"),
        ],
    },
    {
        "name": "可乐鸡翅",
        "description": "甜香入味、色泽诱人的经典菜品，大人小孩都爱吃。",
        "steps": "<ol><li>鸡翅洗净，两面各划两刀方便入味</li><li>冷水下锅焯水去血沫，捞出洗净沥干</li><li>锅中倒少许油，放入鸡翅煎至两面金黄</li><li>加入姜片、葱段翻炒</li><li>倒入可乐没过鸡翅，加入生抽、老抽</li><li>大火烧开转中小火收汁约15分钟</li><li>大火收至汤汁浓稠，撒上芝麻即可</li></ol>",
        "tips": "鸡翅划刀更容易入味。可乐用普通可乐，不要用无糖的。收汁时注意翻动防止粘锅。",
        "tags": ["家常菜", "咸甜", "儿童餐", "烧", "简单"],
        "ingredients": [
            ("鸡翅", "8"), ("葱", "2"), ("姜", "4"),
            ("生抽", "2"), ("老抽", "1"), ("芝麻", "3"),
            ("食用油", "1"),
        ],
    },
]

# Synonym groups: each list is a group of synonyms
SYNONYM_GROUPS = [
    # Vegetables
    ["西红柿", "番茄", "洋柿子"],
    ["土豆", "马铃薯", "洋芋"],
    ["红薯", "地瓜", "番薯", "甘薯"],
    ["玉米", "苞米", "苞谷", "棒子"],
    ["花菜", "菜花", "花椰菜"],
    ["西兰花", "绿花菜", "青花菜", "花椰菜"],
    ["南瓜", "倭瓜", "番瓜"],
    ["黄瓜", "青瓜", "胡瓜"],
    ["苦瓜", "凉瓜"],
    ["茄子", "矮瓜", "落苏"],
    ["胡萝卜", "红萝卜"],
    ["白萝卜", "萝卜"],
    ["菠菜", "波菜", "菠棱菜"],
    ["生菜", "莴苣叶", "叶用莴苣"],
    ["芹菜", "西芹", "旱芹"],
    ["韭菜", "起阳草", "扁菜"],
    ["藕", "莲藕"],
    ["山药", "淮山", "薯蓣"],
    ["芋头", "芋艿", "毛芋"],
    ["空心菜", "蕹菜", "通菜"],
    ["油麦菜", "油荬菜"],
    ["茼蒿", "蓬蒿", "皇帝菜"],
    ["竹笋", "笋", "春笋", "冬笋"],
    ["豆芽", "黄豆芽", "绿豆芽"],
    ["秋葵", "黄秋葵", "羊角豆"],
    # Mushrooms
    ["蘑菇", "口蘑", "双孢菇"],
    ["香菇", "花菇", "冬菇"],
    ["平菇", "秀珍菇", "侧耳"],
    ["杏鲍菇", "刺芹菇"],
    ["金针菇", "金菇", "朴菇"],
    ["木耳", "黑木耳", "云耳"],
    ["银耳", "白木耳", "雪耳"],
    # Tofu & bean products
    ["豆腐", "水豆腐"],
    ["嫩豆腐", "内酯豆腐", "绢豆腐"],
    ["老豆腐", "北豆腐"],
    ["豆腐皮", "千张", "百叶"],
    ["腐竹", "豆腐衣", "豆皮"],
    ["豆干", "豆腐干", "香干"],
    # Meat
    ["猪肉", "猪瘦肉"],
    ["猪五花肉", "五花肉"],
    ["猪里脊", "里脊肉"],
    ["猪排骨", "排骨", "肋排"],
    ["肉末", "肉沫", "肉糜", "肉馅"],
    ["鸡胸肉", "鸡胸"],
    ["鸡翅", "鸡翅膀", "鸡中翅"],
    ["鸡爪", "凤爪", "鸡脚"],
    ["羊肉", "羊羔肉"],
    ["腊肉", "咸肉", "烟肉"],
    ["火腿", "火腿肉"],
    ["培根", "烟肉片"],
    ["香肠", "腊肠"],
    # Seafood
    ["虾仁", "虾米仁", "虾肉"],
    ["大虾", "明虾", "对虾"],
    ["基围虾", "沙虾"],
    ["鱿鱼", "柔鱼", "枪乌贼"],
    ["墨鱼", "乌贼"],
    ["蛤蜊", "花蛤", "花甲"],
    ["扇贝", "带子"],
    ["虾皮", "海米皮"],
    ["虾米", "海米", "开洋"],
    ["海带", "昆布"],
    ["紫菜", "海苔"],
    # Eggs
    ["鸡蛋", "蛋", "鸡子"],
    ["皮蛋", "松花蛋", "变蛋"],
    ["鹌鹑蛋", "鸟蛋"],
    # Alliums & herbs
    ["葱", "小葱", "香葱", "细葱"],
    ["大葱", "京葱", "章丘葱"],
    ["蒜", "大蒜", "蒜头"],
    ["姜", "生姜", "老姜"],
    ["洋葱", "圆葱", "玉葱"],
    ["香菜", "芫荽", "胡荽"],
    # Seasonings
    ["盐", "食盐", "细盐"],
    ["糖", "白糖", "白砂糖", "绵白糖"],
    ["冰糖", "老冰糖", "单晶冰糖"],
    ["酱油", "豉油"],
    ["生抽", "鲜酱油", "淡酱油"],
    ["老抽", "浓酱油"],
    ["蚝油", "耗油"],
    ["醋", "食醋"],
    ["香醋", "镇江醋"],
    ["陈醋", "老陈醋", "山西醋"],
    ["料酒", "烹饪酒", "煮酒"],
    ["花椒", "大红袍花椒", "川椒"],
    ["花椒粉", "花椒面"],
    ["八角", "大料", "大茴香"],
    ["桂皮", "肉桂"],
    ["干辣椒", "辣椒干", "干红椒"],
    ["辣椒粉", "辣椒面", "红辣椒粉"],
    ["小米辣", "小米椒"],
    ["胡椒粉", "胡椒"],
    ["黑胡椒", "黑椒"],
    ["五香粉", "五料粉"],
    ["孜然粉", "孜然", "安息茴香"],
    ["咖喱粉", "咖喱"],
    ["淀粉", "生粉", "太白粉"],
    ["玉米淀粉", "玉米生粉", "鹰粟粉"],
    ["面粉", "小麦粉", "中筋粉"],
    # Oils
    ["食用油", "植物油", "色拉油"],
    ["芝麻油", "香油", "麻油"],
    ["花生油", "花生食用油"],
    ["菜籽油", "菜油", "油菜籽油"],
    ["橄榄油", "初榨橄榄油"],
    # Sauces
    ["豆瓣酱", "郫县豆瓣", "辣豆瓣酱"],
    ["甜面酱", "甜酱"],
    ["辣椒酱", "辣酱"],
    ["芝麻酱", "麻酱"],
    ["番茄酱", "茄汁", "番茄沙司"],
    ["腐乳", "豆腐乳", "霉豆腐"],
    ["豆豉", "豆豉酱"],
    ["味精", "味素"],
    ["鸡精", "鸡粉"],
    # Staple foods
    ["面条", "挂面", "拉面"],
    ["粉丝", "细粉", "龙口粉丝"],
    ["河粉", "沙河粉", "粿条"],
    ["年糕", "糍粑", "水磨年糕"],
    # Others
    ["红枣", "大枣"],
    ["枸杞", "枸杞子", "宁夏枸杞"],
    ["桂圆", "龙眼", "龙眼肉"],
    ["芝麻", "白芝麻", "胡麻"],
    ["花生", "花生米", "落花生"],
    ["辣椒油", "红油", "辣油"],
    ["花椒油", "藤椒油"],
    ["蒸鱼豉油", "蒸鱼酱油"],
    ["干贝", "瑶柱", "江珧柱"],
    ["黄花菜", "金针菜", "忘忧草"],
    ["百合", "百合干"],
]


# =====================================================
# Database operations
# =====================================================

async def reset_database():
    """Drop all tables and recreate them."""
    engine = create_async_engine(settings.DATABASE_URL)
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
        await conn.run_sync(Base.metadata.create_all)
    await engine.dispose()
    print("[OK] Database tables dropped and recreated.")


async def seed_data():
    """Insert sample data into the database."""
    engine = create_async_engine(settings.DATABASE_URL)
    session_factory = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

    async with session_factory() as db:
        # ===== Tag Categories =====
        tag_cats = {}
        for name in TAG_CATEGORIES:
            db.add(TagCategory(name=name))
        await db.flush()
        for c in (await db.execute(select(TagCategory))).scalars().all():
            tag_cats[c.name] = c.id

        # ===== Tags =====
        tags = {}
        for name, cat_name in TAGS:
            db.add(Tag(name=name, category_id=tag_cats[cat_name]))
        await db.flush()
        for t in (await db.execute(select(Tag))).scalars().all():
            tags[t.name] = t

        # ===== Ingredient Categories =====
        ing_cats = {}
        for name in INGREDIENT_CATEGORIES:
            db.add(IngredientCategory(name=name))
        await db.flush()
        for c in (await db.execute(select(IngredientCategory))).scalars().all():
            ing_cats[c.name] = c.id

        # ===== Ingredients =====
        ings = {}
        for name, unit, cal, cat_name in INGREDIENTS:
            db.add(Ingredient(name=name, unit=unit, calorie=cal, category_id=ing_cats[cat_name]))
        await db.flush()
        for i in (await db.execute(select(Ingredient))).scalars().all():
            ings[i.name] = i

        # ===== Recipes =====
        for r_data in RECIPES:
            recipe = Recipe(
                name=r_data["name"],
                description=r_data["description"],
                steps=r_data["steps"],
                tips=r_data["tips"],
            )
            for tag_name in r_data["tags"]:
                recipe.tags.append(tags[tag_name])
            db.add(recipe)
            await db.flush()
            for ing_name, amount in r_data["ingredients"]:
                db.add(RecipeIngredient(
                    recipe_id=recipe.id,
                    ingredient_id=ings[ing_name].id,
                    amount=amount,
                ))

        await db.commit()
        print(f"[OK] Seed data inserted:")
        print(f"     Tag categories:        {len(TAG_CATEGORIES)}")
        print(f"     Tags:                  {len(TAGS)}")
        print(f"     Ingredient categories: {len(INGREDIENT_CATEGORIES)}")
        print(f"     Ingredients:           {len(INGREDIENTS)}")
        print(f"     Recipes:               {len(RECIPES)}")

    await engine.dispose()

    # Sync MeiliSearch index
    try:
        from app.services.search import index_recipe, setup_index, update_synonyms
        from sqlalchemy.orm import selectinload

        setup_index()
        print("[OK] MeiliSearch index configured.")

        # Index recipes
        engine2 = create_async_engine(settings.DATABASE_URL)
        sf2 = async_sessionmaker(engine2, class_=AsyncSession, expire_on_commit=False)
        async with sf2() as db2:
            result = await db2.execute(
                select(Recipe).options(
                    selectinload(Recipe.tags),
                    selectinload(Recipe.recipe_ingredients)
                    .selectinload(RecipeIngredient.ingredient)
                    .selectinload(Ingredient.category_rel),
                )
            )
            for r in result.scalars().unique().all():
                tag_names = [t.name for t in r.tags]
                main_ings = [
                    ri.ingredient.name for ri in r.recipe_ingredients
                    if ri.ingredient and ri.ingredient.category_rel
                    and ri.ingredient.category_rel.name in {"主料", "辅料"}
                ]
                index_recipe(r.id, r.name, tag_names, main_ings)
        await engine2.dispose()
        print("[OK] Search index synced.")

        # Load synonyms
        synonyms_dict = {}
        for group in SYNONYM_GROUPS:
            if len(group) >= 2:
                synonyms_dict[group[0]] = group[1:]
        update_synonyms(synonyms_dict)
        print(f"[OK] Synonyms loaded: {len(SYNONYM_GROUPS)} groups.")
    except Exception as e:
        print(f"[WARN] Search index sync failed: {e}")


def export_synonyms():
    """Export synonym groups to a JSON file."""
    output_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "synonyms.json")
    data = {}
    for group in SYNONYM_GROUPS:
        if len(group) >= 2:
            data[group[0]] = group[1:]
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print(f"[OK] Synonyms exported to {output_path} ({len(data)} groups)")


async def main():
    if "--reset" in sys.argv:
        await reset_database()
    await seed_data()
    export_synonyms()
    print("\nDone!")


if __name__ == "__main__":
    asyncio.run(main())
